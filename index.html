<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ç±³å¥‡æ•¸å­¸">
<link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3069/3069172.png">
<title>èƒ¤å½¥çš„é­”æ³•æ•¸å­¸å±‹</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Varela+Round&display=swap');

:root{
  --red:#E3001B; --black:#111; --yellow:#FFD700;
}

body{
  margin:0; font-family:'Fredoka One';
  background:radial-gradient(circle,#8a0000,#2b0000);
  height:100vh; overflow:hidden;
  display:flex; justify-content:center; align-items:center;
  user-select:none;
}

#magic-canvas{position:absolute; inset:0; z-index:0;}

#game{
  position:relative; z-index:2;
  width:90%; max-width:500px; height:85vh;
  background:#fff; border-radius:40px;
  border:8px solid var(--black);
  box-shadow:0 20px 40px rgba(0,0,0,.45);
  overflow:hidden;
}

.screen{display:none; height:100%; padding:20px; text-align:center;}
.screen.active{display:flex; flex-direction:column; justify-content:center;}

h1{color:var(--red); text-shadow:2px 2px 0 var(--black);}

.jelly{
  background:var(--yellow); border:4px solid var(--black);
  padding:15px 40px; border-radius:50px;
  font-size:1.6rem; cursor:pointer;
  box-shadow:0 8px 0 #c49a00;
}
.jelly:active{transform:translateY(8px); box-shadow:none;}

.hud{
  background:var(--red); color:#fff;
  padding:12px 20px;
  display:flex; justify-content:space-between;
  font-size:1.2rem;
}

.question{font-size:4rem; margin:20px 0;}
.options{
  display:grid; grid-template-columns:repeat(2,1fr);
  gap:15px;
}

.opt{
  border:4px solid var(--black);
  border-radius:20px;
  padding:20px;
  font-size:2.3rem;
  cursor:pointer;
  box-shadow:0 6px 0 #ddd;
}
.opt:active{transform:translateY(6px); box-shadow:none;}
.correct{background:#4CD964;color:#fff;}
.wrong{background:#E3001B;color:#fff;}

#hint{
  font-family:'Varela Round';
  height:1.6em; color:#555;
}

#toast,#reward-toast{
  position:absolute; inset:0;
  display:none; align-items:center; justify-content:center;
  z-index:20;
}
#toast{background:rgba(0,0,0,.6); font-size:3rem; color:#fff;}
#toast.show{display:flex;}

#reward-toast{background:rgba(0,0,0,.65);}
#reward-toast.show{display:flex;}

#reward-box{
  background:var(--yellow);
  border:6px solid var(--black);
  border-radius:30px;
  padding:30px 40px;
  font-size:2rem;
  animation:pop .4s;
}

@keyframes pop{
  0%{transform:scale(0);}
  80%{transform:scale(1.1);}
  100%{transform:scale(1);}
}
</style>
</head>

<body>
<audio id="bgm" loop preload="auto">
  <source src="happy-kids-333364.mp3" type="audio/mpeg">
</audio>

<canvas id="magic-canvas"></canvas>

<div id="game">
  <div id="toast">LEVEL UP â­</div>

  <div id="reward-toast">
    <div id="reward-box"></div>
  </div>

  <div id="start" class="screen active">
    <h1>èƒ¤å½¥çš„<br>é­”æ³•ç®—è¡“</h1>
    <button class="jelly" onclick="game.start()">é–‹å§‹å†’éšª</button>
  </div>

  <div id="play" class="screen">
    <div class="hud">
      <div>LEVEL <span id="lvl">1</span></div>
      <div>â˜… <span id="score">0</span></div>
    </div>
    <div class="question" id="q"></div>
    <div id="hint"></div>
    <div class="options" id="opts"></div>
  </div>

  <div id="end" class="screen">
    <h1 id="title">å®Œæˆï¼</h1>
    <div style="font-size:5rem;color:gold;">â˜… <span id="final"></span></div>
    <button class="jelly" onclick="location.reload()">å†ç©ä¸€æ¬¡</button>
  </div>
</div>

<script>
// ===== ç²’å­èƒŒæ™¯ =====
const canvas=document.getElementById('magic-canvas'),ctx=canvas.getContext('2d');
let PC=innerWidth<500?30:50,P=[];
function resize(){canvas.width=innerWidth;canvas.height=innerHeight}
resize();onresize=resize;

class Ptc{
  constructor(){this.reset()}
  reset(){
    this.x=Math.random()*canvas.width;
    this.y=canvas.height+Math.random()*100;
    this.s=Math.random()*2+1;
    this.v=Math.random()*1+.3;
  }
  draw(){
    this.y-=this.v; if(this.y<0)this.reset();
    ctx.fillStyle="rgba(255,255,255,.6)";
    ctx.beginPath(); ctx.arc(this.x,this.y,this.s,0,7); ctx.fill();
  }
}
for(let i=0;i<PC;i++)P.push(new Ptc());
(function anim(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  P.forEach(p=>p.draw());
  requestAnimationFrame(anim);
})();

// ===== éŠæˆ²ä¸»é«” =====
class Game{
  constructor(){
    this.level=1; this.q=1; this.maxQ=6;
    this.score=0; this.combo=0;

    this.totalStars=parseInt(localStorage.getItem('totalStars')||0);
    this.unlocked=JSON.parse(localStorage.getItem('unlocked')||'{}');

    this.bgm=document.getElementById('bgm');
    this.bgm.volume=.4;

    document.addEventListener('visibilitychange',()=>{
      if(!document.hidden) this.bgm.play().catch(()=>{});
    });
  }

  start(){
    this.applyRewards();
    this.bgm.play().catch(()=>{});
    start.classList.remove('active');
    play.classList.add('active');
    this.next();
  }

  next(){
    if(this.q>this.maxQ){
      if(this.level<10){this.level++;this.q=1;this.levelUp();}
      else return this.end();
    }
    lvl.textContent=this.level;
    score.textContent=this.score;
    this.makeQ();
  }

  levelUp(){
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'),1200);
    setTimeout(()=>this.next(),1300);
  }

  makeQ(){
    hint.textContent='';
    let max=[10,10,20,20,50,50,80,80,100,100][this.level-1];
    let add=Math.random()>.3;
    let a,b,ans;
    if(add){
      a=Math.floor(Math.random()*(max-1))+1;
      b=Math.floor(Math.random()*(max-a))+1;
      ans=a+b;
    }else{
      a=Math.floor(Math.random()*(max-1))+2;
      b=Math.floor(Math.random()*Math.min(10,a));
      ans=a-b;
    }
    q.textContent=`${a} ${add?'+':'-'} ${b} = ?`;
    this.answer=ans;
    this.renderOpts(ans,max,a,b,add);
  }

  renderOpts(ans,max,a,b,add){
    opts.innerHTML='';
    let set=new Set([ans]);
    while(set.size<4){
      let f=ans+[ -2,-1,1,2 ][Math.floor(Math.random()*4)];
      if(f>=0&&f<=max)set.add(f);
    }
    [...set].sort(()=>Math.random()-.5).forEach(n=>{
      let d=document.createElement('div');
      d.className='opt'; d.textContent=n;
      d.onclick=()=>this.check(n,d,a,b,add);
      opts.appendChild(d);
    });
  }

  check(v,el,a,b,add){
    if(v===this.answer){
      el.classList.add('correct');
      this.score++; this.combo++;
      this.totalStars++;
      localStorage.setItem('totalStars',this.totalStars);
      this.checkUnlock();
    }else{
      el.classList.add('wrong');
      this.combo=0;
      hint.textContent=add?`æƒ³ä¸€æƒ³ï¼š${a} å†åŠ  ${b}`:`æƒ³ä¸€æƒ³ï¼š${a} æ¸› ${b}`;
      [...opts.children].forEach(o=>{
        if(+o.textContent===this.answer)o.classList.add('correct');
      });
    }
    setTimeout(()=>{this.q++;this.next()},1300);
  }

  checkUnlock(){
    if(this.totalStars>=20 && !this.unlocked.bg1){
      this.unlock('ğŸ¨ è§£é–é­”æ³•è—è‰²èƒŒæ™¯ï¼','bg1',
        'radial-gradient(circle,#0044aa,#001122)');
    }
    if(this.totalStars>=50 && !this.unlocked.bg2){
      this.unlock('ğŸŒˆ è§£é–å½©è‰²é­”æ³•èƒŒæ™¯ï¼','bg2',
        'radial-gradient(circle,#ff0080,#ffcc00,#00ccff)');
    }
    if(this.totalStars>=100 && !this.unlocked.title){
      this.unlocked.title=true;
      localStorage.setItem('unlocked',JSON.stringify(this.unlocked));
      document.getElementById('title').textContent='ğŸ† æ•¸å­¸å°é­”æ³•å¸«ï¼';
    }
  }

  unlock(text,key,bg){
    this.unlocked[key]=true;
    localStorage.setItem('unlocked',JSON.stringify(this.unlocked));
    document.body.style.background=bg;
    reward-box.textContent=text;
    reward-toast.classList.add('show');
    setTimeout(()=>reward-toast.classList.remove('show'),1500);
  }

  applyRewards(){
    if(this.unlocked.bg2)
      document.body.style.background='radial-gradient(circle,#ff0080,#ffcc00,#00ccff)';
    else if(this.unlocked.bg1)
      document.body.style.background='radial-gradient(circle,#0044aa,#001122)';
  }

  end(){
    play.classList.remove('active');
    end.classList.add('active');
    final.textContent=this.score;
    if(this.unlocked.title)
      document.getElementById('title').textContent='ğŸ† æ•¸å­¸å°é­”æ³•å¸«ï¼';
  }
}

const game=new Game();
</script>
</body>
</html>
