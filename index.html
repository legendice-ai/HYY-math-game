<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç±³å¥‡çš„é­”æ³•æ•¸å­¸å±‹</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Varela+Round&display=swap');

        :root {
            --mickey-red: #E3001B;
            --mickey-black: #111111;
            --mickey-yellow: #FFD700;
            --mickey-white: #FFFFFF;
            --gold-glow: #FFC107;
            --bg-gradient: radial-gradient(circle at center, #8a0000 0%, #2b0000 100%);
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Fredoka One', sans-serif;
            background: var(--bg-gradient);
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--mickey-white);
            user-select: none;
        }

        /* --- é­”æ³•ç²’å­èƒŒæ™¯ Canvas --- */
        #magic-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        /* --- éŠæˆ²ä¸»å®¹å™¨ --- */
        #game-container {
            position: relative;
            z-index: 10;
            width: 90%;
            max-width: 500px;
            height: 85vh;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 40px;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5), 0 20px 50px rgba(0,0,0,0.5);
            border: 8px solid var(--mickey-black);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* --- ç±³å¥‡è€³æœµè£é£¾ --- */
        .mickey-ears {
            position: absolute;
            top: -50px;
            width: 100%;
            height: 60px;
            display: flex;
            justify-content: center;
            gap: 180px;
            z-index: -1;
        }
        .ear {
            width: 120px;
            height: 120px;
            background: var(--mickey-black);
            border-radius: 50%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* --- å±å¹•é€šç”¨æ¨£å¼ --- */
        .screen {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            color: var(--mickey-black);
        }
        .screen.active { display: flex; }

        /* --- UI å…ƒç´  --- */
        h1 {
            font-size: 3rem;
            color: var(--mickey-red);
            text-shadow: 2px 2px 0px var(--mickey-black);
            margin-bottom: 10px;
        }

        p { font-family: 'Varela Round', sans-serif; font-weight: bold; }

        /* --- 3D æœå‡æŒ‰éˆ• --- */
        .jelly-btn {
            background: var(--mickey-yellow);
            color: var(--mickey-black);
            border: 4px solid var(--mickey-black);
            padding: 15px 40px;
            font-size: 1.8rem;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Fredoka One', sans-serif;
            margin: 15px;
            position: relative;
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
            /* 3D æ•ˆæœ */
            box-shadow: 0 8px 0 #c49a00, 0 15px 20px rgba(0,0,0,0.2);
            text-transform: uppercase;
        }

        .jelly-btn:active {
            transform: translateY(8px) scale(0.95);
            box-shadow: 0 0 0 #c49a00, inset 0 5px 10px rgba(0,0,0,0.2);
        }

        .jelly-btn:hover {
            filter: brightness(1.1);
        }

        /* --- éŠæˆ² HUD --- */
        .hud {
            position: absolute;
            top: 0;
            width: 100%;
            background: var(--mickey-red);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
            font-size: 1.2rem;
            border-bottom: 5px solid var(--mickey-black);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .star-badge {
            background: rgba(0,0,0,0.3);
            padding: 5px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .progress-container {
            width: 100%;
            padding: 0 30px;
            margin-top: 80px; /* é¿é–‹ HUD */
        }

        .progress-bar-bg {
            width: 100%;
            height: 15px;
            background: #eee;
            border-radius: 10px;
            border: 2px solid var(--mickey-black);
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--mickey-yellow);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* --- é¡Œç›®å€ --- */
        .question-box {
            font-size: 4.5rem;
            color: var(--mickey-black);
            margin: 20px 0;
            text-shadow: 3px 3px 0px rgba(0,0,0,0.1);
            animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        /* --- é¸é …ç¶²æ ¼ --- */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            width: 100%;
            padding: 10px;
        }

        .option-card {
            background: white;
            border: 4px solid var(--mickey-black);
            border-radius: 25px;
            padding: 20px;
            font-size: 2.5rem;
            color: var(--mickey-black);
            cursor: pointer;
            box-shadow: 0 8px 0 #ddd;
            transition: transform 0.1s;
        }

        .option-card:active {
            transform: translateY(8px);
            box-shadow: 0 0 0 #ddd;
        }

        .correct {
            background-color: #4CD964 !important;
            border-color: #2E7D32 !important;
            box-shadow: 0 8px 0 #2E7D32 !important;
            color: white !important;
            animation: pop 0.3s;
        }

        .wrong {
            background-color: var(--mickey-red) !important;
            border-color: #8B0000 !important;
            box-shadow: 0 8px 0 #8B0000 !important;
            color: white !important;
            animation: shake 0.4s;
        }

        /* --- éŸ³æ•ˆæ§åˆ¶ --- */
        .audio-control {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: var(--mickey-white);
            color: var(--mickey-black);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid var(--mickey-black);
            cursor: pointer;
            z-index: 20;
            font-size: 1.2rem;
        }

        /* --- å‹•ç•« --- */
        @keyframes bounceIn { 0% { transform: scale(0); } 80% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes pop { 50% { transform: scale(1.1); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        @keyframes starSpin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .star-anim { animation: starSpin 0.5s ease-out; }

    </style>
</head>
<body>

    <audio id="bgm" loop>
        <!-- è¼•å¿«BGM -->
        <source src="https://cdn.pixabay.com/download/audio/2022/01/21/audio_335e236611.mp3?filename=happy-kids-loop-109017.mp3" type="audio/mpeg">
    </audio>

    <canvas id="magic-canvas"></canvas>

    <div class="mickey-ears">
        <div class="ear"></div>
        <div class="ear"></div>
    </div>

    <div id="game-container">
        <!-- 1. Start Screen -->
        <div id="start-screen" class="screen active">
            <div style="font-size: 5rem; margin-bottom:-20px;">âœ¨</div>
            <h1>ç±³å¥‡çš„<br>é­”æ³•ç®—è¡“</h1>
            <p style="font-size: 1.2rem; color: #555;">æŒ‘æˆ° 100 é¡†æ˜Ÿæ˜Ÿï¼</p>
            <button class="jelly-btn" onclick="game.start()">é–‹å§‹å†’éšª</button>
        </div>

        <!-- 2. Game Screen -->
        <div id="game-screen" class="screen">
            <div class="hud">
                <span>LEVEL <span id="level-num">1</span></span>
                <div class="star-badge">
                    <span style="color: gold; font-size: 1.5rem;" id="star-icon">â˜…</span> 
                    <span id="score">0</span>
                </div>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar-bg">
                    <div id="progress-bar" class="progress-bar-fill"></div>
                </div>
                <p style="font-size: 0.9rem; color: #999; margin-top: 5px;">Question <span id="q-num">1</span>/10</p>
            </div>

            <div id="question-text" class="question-box"></div>

            <div class="options-grid" id="options-container">
                <!-- Buttons generated via JS -->
            </div>
        </div>

        <!-- 3. Result Screen -->
        <div id="result-screen" class="screen">
            <h1>å†’éšªå®Œæˆï¼</h1>
            <div style="font-size: 6rem; color: gold; text-shadow: 2px 2px 5px rgba(0,0,0,0.3);">â˜… <span id="final-score">0</span></div>
            <p id="result-msg">ä½ æ˜¯æœ€æ£’çš„æ•¸å­¸é­”æ³•å¸«ï¼</p>
            <button class="jelly-btn" onclick="location.reload()">å†ç©ä¸€æ¬¡</button>
        </div>

        <div class="audio-control" id="mute-btn">ğŸµ</div>
    </div>

<script>
/**
 * é­”æ³•ç²’å­èƒŒæ™¯æ•ˆæœ
 */
const canvas = document.getElementById('magic-canvas');
const ctx = canvas.getContext('2d');
let particles = [];

function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

class Particle {
    constructor() {
        this.reset();
    }
    reset() {
        this.x = Math.random() * canvas.width;
        this.y = canvas.height + Math.random() * 100;
        this.size = Math.random() * 4 + 1;
        this.speed = Math.random() * 1 + 0.5;
        this.opacity = Math.random() * 0.5 + 0.2;
        this.color = Math.random() > 0.8 ? '#FFD700' : '#FFFFFF'; // é‡‘è‰²æˆ–ç™½è‰²
    }
    update() {
        this.y -= this.speed;
        if (this.y < -10) this.reset();
    }
    draw() {
        ctx.fillStyle = this.color;
        ctx.globalAlpha = this.opacity;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = 1;
        
        // é–ƒçˆæ•ˆæœ
        if(Math.random() > 0.95) {
            ctx.shadowBlur = 10;
            ctx.shadowColor = "white";
        } else {
            ctx.shadowBlur = 0;
        }
    }
}

for (let i = 0; i < 50; i++) particles.push(new Particle());

function animateParticles() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    particles.forEach(p => {
        p.update();
        p.draw();
    });
    requestAnimationFrame(animateParticles);
}
animateParticles();

/**
 * éŠæˆ²ä¸»é‚è¼¯
 */
class MathGame {
    constructor() {
        this.levels = 10;
        this.questionsPerLevel = 10;
        this.currentLevel = 1;
        this.currentQ = 1;
        this.score = 0;
        this.isProcessing = false;
        
        this.bgm = document.getElementById('bgm');
        this.isMuted = false;
        this.bgm.volume = 0.4;
        
        document.getElementById('mute-btn').addEventListener('click', () => this.toggleAudio());
    }

    toggleAudio() {
        if (this.isMuted) {
            this.bgm.play().catch(()=>{});
            document.getElementById('mute-btn').textContent = "ğŸµ";
            this.isMuted = false;
        } else {
            this.bgm.pause();
            document.getElementById('mute-btn').textContent = "ğŸ”‡";
            this.isMuted = true;
        }
    }

    start() {
        // è§£é–éŸ³é »æ’­æ”¾
        if(!this.isMuted) this.bgm.play().catch(e => console.log("Audio block"));
        
        document.getElementById('start-screen').classList.remove('active');
        document.getElementById('game-screen').classList.add('active');
        this.startLevel(1);
    }

    startLevel(lvl) {
        this.currentLevel = lvl;
        this.currentQ = 1;
        document.getElementById('level-num').textContent = lvl;
        this.nextQuestion();
    }

    nextQuestion() {
        if (this.currentQ > this.questionsPerLevel) {
            // Level Complete
            if (this.currentLevel < this.levels) {
                this.currentLevel++;
                // æ’­æ”¾éå ´éŸ³æ•ˆ(å¯é¸)
                alert(`æ­å–œé€šé Level ${this.currentLevel - 1}! æº–å‚™é€²å…¥ Level ${this.currentLevel}`);
                this.startLevel(this.currentLevel);
            } else {
                this.endGame();
            }
            return;
        }

        this.isProcessing = false;
        this.updateHUD();
        
        const qData = this.generateMath(this.currentLevel);
        this.correctAnswer = qData.answer;
        
        // é¡¯ç¤ºé¡Œç›®
        document.getElementById('question-text').textContent = qData.text;
        
        // ç”Ÿæˆé¸é …
        this.renderOptions(qData.answer, qData.maxRange);
    }

    updateHUD() {
        document.getElementById('q-num').textContent = this.currentQ;
        document.getElementById('score').textContent = this.score;
        const pct = ((this.currentQ - 1) / this.questionsPerLevel) * 100;
        document.getElementById('progress-bar').style.width = `${pct}%`;
    }

    /**
     * é›£åº¦æ›²ç·šè¨­è¨ˆ (1-100 ç¯„åœ)
     * é©åˆ 6 æ­²å…’ç«¥
     */
    generateMath(level) {
        let n1, n2, ans, op, text;
        let max = 10;
        
        // é›£åº¦è¨­å®š
        if (level <= 2) max = 10;       // L1-2: 10ä»¥å…§
        else if (level <= 4) max = 20;  // L3-4: 20ä»¥å…§
        else if (level <= 6) max = 50;  // L5-6: 50ä»¥å…§
        else if (level <= 8) max = 80;  // L7-8: 80ä»¥å…§
        else max = 100;                 // L9-10: 100ä»¥å…§

        // é‹ç®—ç¬¦èˆ‡é‚è¼¯
        // L1-3 ä¸»è¦åŠ æ³•, å¶çˆ¾æ¸›æ³•
        // L4-10 æ··åˆ
        const isAdd = Math.random() > (level > 3 ? 0.5 : 0.2);
        op = isAdd ? '+' : '-';

        if (isAdd) {
            // åŠ æ³•: ç¢ºä¿ç¸½å’Œä¸è¶…é max
            n1 = Math.floor(Math.random() * (max - 1)) + 1;
            n2 = Math.floor(Math.random() * (max - n1)) + 1;
            ans = n1 + n2;
        } else {
            // æ¸›æ³•: ç¢ºä¿ä¸å‡ºç¾è² æ•¸
            n1 = Math.floor(Math.random() * (max - 1)) + 2; // è‡³å°‘æ˜¯2
            n2 = Math.floor(Math.random() * n1); // æ¯”n1å°
            ans = n1 - n2;
        }

        return { text: `${n1} ${op} ${n2} = ?`, answer: ans, maxRange: max };
    }

    renderOptions(correct, range) {
        let opts = new Set([correct]);
        
        // æ™ºèƒ½ç”Ÿæˆå¹²æ“¾é …
        while(opts.size < 4) {
            let fake;
            let r = Math.random();
            if (r < 0.3) fake = correct + 1; // æ¥è¿‘éŒ¯èª¤
            else if (r < 0.6) fake = correct - 1;
            else if (r < 0.8) fake = correct + 10; // æ··æ·†åä½æ•¸
            else fake = Math.floor(Math.random() * (range + 1));
            
            if (fake >= 0 && fake <= 100 && fake !== correct) {
                opts.add(fake);
            }
        }

        const arr = Array.from(opts).sort(() => Math.random() - 0.5);
        const container = document.getElementById('options-container');
        container.innerHTML = '';

        arr.forEach(num => {
            const btn = document.createElement('div');
            btn.className = 'option-card';
            btn.textContent = num;
            btn.onclick = (e) => this.check(num, e.target);
            container.appendChild(btn);
        });
    }

    check(val, el) {
        if (this.isProcessing) return;
        this.isProcessing = true;

        if (val === this.correctAnswer) {
            // Correct
            el.classList.add('correct');
            this.score++;
            this.speak("æ£’ï¼"); // ç°¡å–®èªéŸ³çå‹µ
            
            // æ˜Ÿæ˜Ÿå‹•ç•«
            const star = document.getElementById('star-icon');
            star.classList.remove('star-anim');
            void star.offsetWidth;
            star.classList.add('star-anim');

        } else {
            // Wrong
            el.classList.add('wrong');
            this.speak("å™¢");
            // é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
            document.querySelectorAll('.option-card').forEach(c => {
                if(parseInt(c.textContent) === this.correctAnswer) {
                    setTimeout(() => c.classList.add('correct'), 200);
                }
            });
        }

        setTimeout(() => {
            this.currentQ++;
            this.nextQuestion();
        }, 1500);
    }

    speak(text) {
        if (!this.isMuted && window.speechSynthesis) {
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'zh-TW';
            u.rate = 1.2;
            u.pitch = 1.3;
            window.speechSynthesis.speak(u);
        }
    }

    endGame() {
        document.getElementById('game-screen').classList.remove('active');
        document.getElementById('result-screen').classList.add('active');
        document.getElementById('final-score').textContent = this.score;
        this.speak("æ­å–œå®Œæˆæ‰€æœ‰æŒ‘æˆ°");
    }
}

const game = new MathGame();

</script>
</body>
</html>